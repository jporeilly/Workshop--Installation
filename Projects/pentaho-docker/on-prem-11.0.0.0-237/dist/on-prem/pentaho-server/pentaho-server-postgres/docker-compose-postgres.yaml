services:
  pentaho-server:
    image: ${PENTAHO_IMAGE_NAME}:${PENTAHO_VERSION}
    platform: linux/amd64    
    build:
      context: ../../../../assemblies/pentaho-server
      dockerfile: Dockerfile
      args:
        PENTAHO_VERSION: ${PENTAHO_VERSION}
    hostname: pentaho-server-postgres
    container_name: pentaho-server-postgres
    ports:
      - "${PORT}:8090"
    stop_grace_period: "0s"
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 5g
    volumes:
      #SOFTWARE_OVERRIDE_FOLDER is a folder that contains the software "changes" that will be copied to the container
      - "${SOFTWARE_OVERRIDE_FOLDER}/:/docker-entrypoint-init"

      #CONFIG_FOLDER is a folder that contains the configuration files that will be copied to the container
      - "${CONFIG_FOLDER}:${PENTAHO_HOME}"

      #LOG_FOLDER is a folder that contains the log files that will be generated by the container
      - "${LOG_FOLDER}:/opt/pentaho/pentaho-server/tomcat/logs"

      #AdditionalVolumePlaceholder-Do not modify this line.
    environment:
      - CATALINA_OPTS=-Dfile.encoding=utf8 -XX:MinRAMPercentage=50.0 -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC
      - LICENSE_URL=${LICENSE_URL}
      - KETTLE_HOME=${PENTAHO_HOME}
      - PENTAHO_HOME=${PENTAHO_HOME}
      - PENTAHO_JAVA_HOME=/opt/java/openjdk
      - JAVA_HOME=/opt/java/openjdk
    networks:
      - pentaho-network

    depends_on:
      repository:
        condition: service_healthy

  repository:
    image: postgres:${DATABASE_VERSION}
    container_name: pentaho-postgres-17
    hostname: repository
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - "./db_init_postgres/:/docker-entrypoint-initdb.d/"
      - "./db_init_postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro"
      - "./db_init_postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro"
      - repository-data:/var/lib/postgresql/data
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - pentaho-network

volumes:
  repository-data:
  server_jackrabbit:

networks:
  pentaho-network:
    driver: bridge
