# =============================================================================
# PostgreSQL Initialization ConfigMap
# =============================================================================
# SQL scripts to initialize Pentaho repository databases
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: pentaho
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: init-scripts
data:
  # Script 1: Create JackRabbit database and user
  01-create-jcr.sql: |
    -- JackRabbit Content Repository Database
    CREATE USER jcr_user WITH PASSWORD 'password';
    CREATE DATABASE jackrabbit WITH OWNER = jcr_user ENCODING = 'UTF8';
    GRANT ALL PRIVILEGES ON DATABASE jackrabbit TO jcr_user;

  # Script 2: Create Quartz database and user
  02-create-quartz.sql: |
    -- Quartz Scheduler Database
    CREATE USER pentaho_user WITH PASSWORD 'password';
    CREATE DATABASE quartz WITH OWNER = pentaho_user ENCODING = 'UTF8';
    GRANT ALL PRIVILEGES ON DATABASE quartz TO pentaho_user;

    -- Connect to quartz database and create tables
    \c quartz

    -- Quartz Tables
    CREATE TABLE QRTZ6_JOB_DETAILS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        JOB_NAME VARCHAR(200) NOT NULL,
        JOB_GROUP VARCHAR(200) NOT NULL,
        DESCRIPTION VARCHAR(250) NULL,
        JOB_CLASS_NAME VARCHAR(250) NOT NULL,
        IS_DURABLE BOOL NOT NULL,
        IS_NONCONCURRENT BOOL NOT NULL,
        IS_UPDATE_DATA BOOL NOT NULL,
        REQUESTS_RECOVERY BOOL NOT NULL,
        JOB_DATA BYTEA NULL,
        PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)
    );

    CREATE TABLE QRTZ6_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        JOB_NAME VARCHAR(200) NOT NULL,
        JOB_GROUP VARCHAR(200) NOT NULL,
        DESCRIPTION VARCHAR(250) NULL,
        NEXT_FIRE_TIME BIGINT NULL,
        PREV_FIRE_TIME BIGINT NULL,
        PRIORITY INTEGER NULL,
        TRIGGER_STATE VARCHAR(16) NOT NULL,
        TRIGGER_TYPE VARCHAR(8) NOT NULL,
        START_TIME BIGINT NOT NULL,
        END_TIME BIGINT NULL,
        CALENDAR_NAME VARCHAR(200) NULL,
        MISFIRE_INSTR SMALLINT NULL,
        JOB_DATA BYTEA NULL,
        PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
        FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP) REFERENCES QRTZ6_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP)
    );

    CREATE TABLE QRTZ6_SIMPLE_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        REPEAT_COUNT BIGINT NOT NULL,
        REPEAT_INTERVAL BIGINT NOT NULL,
        TIMES_TRIGGERED BIGINT NOT NULL,
        PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
        FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) REFERENCES QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
    );

    CREATE TABLE QRTZ6_CRON_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        CRON_EXPRESSION VARCHAR(120) NOT NULL,
        TIME_ZONE_ID VARCHAR(80),
        PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
        FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) REFERENCES QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
    );

    CREATE TABLE QRTZ6_SIMPROP_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        STR_PROP_1 VARCHAR(512) NULL,
        STR_PROP_2 VARCHAR(512) NULL,
        STR_PROP_3 VARCHAR(512) NULL,
        INT_PROP_1 INT NULL,
        INT_PROP_2 INT NULL,
        LONG_PROP_1 BIGINT NULL,
        LONG_PROP_2 BIGINT NULL,
        DEC_PROP_1 NUMERIC(13,4) NULL,
        DEC_PROP_2 NUMERIC(13,4) NULL,
        BOOL_PROP_1 BOOL NULL,
        BOOL_PROP_2 BOOL NULL,
        PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
        FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) REFERENCES QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
    );

    CREATE TABLE QRTZ6_BLOB_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        BLOB_DATA BYTEA NULL,
        PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
        FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) REFERENCES QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
    );

    CREATE TABLE QRTZ6_CALENDARS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        CALENDAR_NAME VARCHAR(200) NOT NULL,
        CALENDAR BYTEA NOT NULL,
        PRIMARY KEY (SCHED_NAME,CALENDAR_NAME)
    );

    CREATE TABLE QRTZ6_PAUSED_TRIGGER_GRPS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP)
    );

    CREATE TABLE QRTZ6_FIRED_TRIGGERS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        ENTRY_ID VARCHAR(95) NOT NULL,
        TRIGGER_NAME VARCHAR(200) NOT NULL,
        TRIGGER_GROUP VARCHAR(200) NOT NULL,
        INSTANCE_NAME VARCHAR(200) NOT NULL,
        FIRED_TIME BIGINT NOT NULL,
        SCHED_TIME BIGINT NOT NULL,
        PRIORITY INTEGER NOT NULL,
        STATE VARCHAR(16) NOT NULL,
        JOB_NAME VARCHAR(200) NULL,
        JOB_GROUP VARCHAR(200) NULL,
        IS_NONCONCURRENT BOOL NULL,
        REQUESTS_RECOVERY BOOL NULL,
        PRIMARY KEY (SCHED_NAME,ENTRY_ID)
    );

    CREATE TABLE QRTZ6_SCHEDULER_STATE (
        SCHED_NAME VARCHAR(120) NOT NULL,
        INSTANCE_NAME VARCHAR(200) NOT NULL,
        LAST_CHECKIN_TIME BIGINT NOT NULL,
        CHECKIN_INTERVAL BIGINT NOT NULL,
        PRIMARY KEY (SCHED_NAME,INSTANCE_NAME)
    );

    CREATE TABLE QRTZ6_LOCKS (
        SCHED_NAME VARCHAR(120) NOT NULL,
        LOCK_NAME VARCHAR(40) NOT NULL,
        PRIMARY KEY (SCHED_NAME,LOCK_NAME)
    );

    -- Create indexes
    CREATE INDEX IDX_QRTZ6_J_REQ_RECOVERY ON QRTZ6_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);
    CREATE INDEX IDX_QRTZ6_J_GRP ON QRTZ6_JOB_DETAILS(SCHED_NAME,JOB_GROUP);
    CREATE INDEX IDX_QRTZ6_T_J ON QRTZ6_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
    CREATE INDEX IDX_QRTZ6_T_JG ON QRTZ6_TRIGGERS(SCHED_NAME,JOB_GROUP);
    CREATE INDEX IDX_QRTZ6_T_C ON QRTZ6_TRIGGERS(SCHED_NAME,CALENDAR_NAME);
    CREATE INDEX IDX_QRTZ6_T_G ON QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);
    CREATE INDEX IDX_QRTZ6_T_STATE ON QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_STATE);
    CREATE INDEX IDX_QRTZ6_T_N_STATE ON QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);
    CREATE INDEX IDX_QRTZ6_T_N_G_STATE ON QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);
    CREATE INDEX IDX_QRTZ6_T_NEXT_FIRE_TIME ON QRTZ6_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);
    CREATE INDEX IDX_QRTZ6_T_NFT_ST ON QRTZ6_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);
    CREATE INDEX IDX_QRTZ6_T_NFT_MISFIRE ON QRTZ6_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);
    CREATE INDEX IDX_QRTZ6_T_NFT_ST_MISFIRE ON QRTZ6_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);
    CREATE INDEX IDX_QRTZ6_T_NFT_ST_MISFIRE_GRP ON QRTZ6_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);
    CREATE INDEX IDX_QRTZ6_FT_TRIG_INST_NAME ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);
    CREATE INDEX IDX_QRTZ6_FT_INST_JOB_REQ_RCVRY ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);
    CREATE INDEX IDX_QRTZ6_FT_J_G ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
    CREATE INDEX IDX_QRTZ6_FT_JG ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);
    CREATE INDEX IDX_QRTZ6_FT_T_G ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);
    CREATE INDEX IDX_QRTZ6_FT_TG ON QRTZ6_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);

    -- Grant permissions
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO pentaho_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO pentaho_user;

  # Script 3: Create Hibernate database and user
  03-create-hibernate.sql: |
    -- Hibernate Repository Database
    CREATE USER hibuser WITH PASSWORD 'password';
    CREATE DATABASE hibernate WITH OWNER = hibuser ENCODING = 'UTF8';
    GRANT ALL PRIVILEGES ON DATABASE hibernate TO hibuser;

    -- Connect to hibernate database and create tables
    \c hibernate

    -- Hibernate ID Table
    CREATE TABLE DATASOURCE (
        DATASOURCE_ID SERIAL PRIMARY KEY,
        NAME VARCHAR(50) NOT NULL UNIQUE,
        DRIVER VARCHAR(256) NOT NULL,
        URL VARCHAR(512) NOT NULL,
        USERNAME VARCHAR(50),
        PASSWORD VARCHAR(150),
        QUERY VARCHAR(100),
        MAX_ACTV_CONN INTEGER DEFAULT 10,
        IDLE_CONN INTEGER,
        WAIT INTEGER,
        ACCESS_TYPE VARCHAR(10) DEFAULT 'native'
    );

    -- Grant permissions
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO hibuser;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO hibuser;
