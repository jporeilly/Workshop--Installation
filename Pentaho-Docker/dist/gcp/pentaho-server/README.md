# Pentaho Server Docker Project

This project provides a Docker setup for Pentaho Server (PUC). The setup includes Dockerfiles, Docker Compose configurations, and necessary scripts to build and run Pentaho Server in a containerized environment.

## Project Structure

### `dist/gcp/pentaho-server/`

This folder contains resources and configurations for running Pentaho Server Docker container with several database variants. For this example we will use MySql database.

- **`pentaho-server-mysql/`**: Contains Docker Compose configurations for running Pentaho Server with MySql database.
    - **`pentaho-server-gcp-mysql.yaml`**: Yaml file for deploying Pentaho Server with MySql database into kubernetes cluster.

### `config/`
This folder contains configuration files for the Pentaho Server. It is mounted as a volume in the Docker container to allow customization of the server settings.

### `db_init_mysql/`
This folder should contain the database scripts which needs to be run in the RDS DB Instance.

### `logs/`
This folder is used to store logs generated by the Pentaho Server. It is mounted as a volume in the Docker container to persist logs across container restarts.

### `softwareOverride/`
This folder should contain any configuration files that need to override the default configurations in the Pentaho Server installation.

## Usage

### Prerequisites

- Docker
- Docker Compose

### Building the Docker Image

1. Navigate to the `assemblies/pentaho-sever/` directory.
2. Place the required Pentaho Server distribution software ZIP files in the `assemblies/pentaho-server/stagedArtifacts/` folder.
3. Change the `Dockerfile` `ARG PENTAHO_VERSION` to the desired version of Pentaho Server.
4. Build the Docker image using the following command:
   ```sh
   docker build -t pentaho/pentaho-server:11.x .
   ```
5. tag this image and push it using following commands into ECR
    ```sh
    docker tag pentaho-server:latest LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY/IMAGE:TAG
    docker push LOCATION-docker.pkg.dev/PROJECT-ID/REPOSITORY/IMAGE:TAG
    ```
    ```sh
    following exmple is shown below
    docker tag pentaho/pentaho-server:10.3.0.0-272 us-east1-docker.pkg.dev/pentaho-lee-cheng/pentaho-docker-repo/pentaho-server:272
    docker push us-east1-docker.pkg.dev/pentaho-lee-cheng/pentaho-docker-repo/pentaho-server:272
   ```

### Deploying into Kubernates and checking logs

## Update yaml Files

Create the required Google Cloud + GKE + IAM + Storage resources:
• Create GKE Cluster
• Create GCS Bucket (acts as storage account/file share)
• Create Artifact Registry (container registry)
• Create Kubernetes Service Account
• Enable Workload Identity
• Bind K8s Service Account to Google IAM Service Account
for binding K8s Service Account to Google IAM Service Account, refer to [Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
ex: gcloud iam service-accounts add-iam-policy-binding gke-gcs-access@pentaho-lee-cheng.iam.gserviceaccount.com --role roles/iam.workloadIdentityUser --member "serviceAccount:pentaho-lee-cheng.svc.id.goog[pentaho-server/gcs-access-sa]

Update followings in the yaml files

1- containers:image Replace with your image
2- env:LICENSE_URL # Replace with your actual license URL
3- volumeMounts:subPath # Update subpath for each mount path if needed

Other values can be changed or keep the name same as YAML file like Namespace, PersistentVolume, PersistentVolumeClaim, ServiceAccount etc..

## Login to GKE Cluster

Run following commands to connect GPC

gcloud auth login

gcloud auth configure-docker <Artificat_Registry>
e.g.- gcloud auth configure-docker us-east1-docker.pkg.dev

gcloud config set project <project_name>
e.g.- gcloud config set project pentaho-lee-cheng

gcloud container clusters get-credentials <CLUSTER_NAME> --region <REGION> --project <PROJECT_ID>
e.g.- gcloud container clusters get-credentials  pentaho-standard-cluster --region  us-central1 --project pentaho-lee-cheng

## Deploying pentaho-server

1. kubectl apply -f /path/pentaho-server-gcp-mysql.yaml
    - This command will deploy the Pentaho Server with MySQL database into the GKE cluster.
2. kubectl logs -f pentaho-server-78855f6777-z62w6  -n pentaho-server --all-containers
    - This command will show the logs of the Pentaho Server pod.
    - Replace `pentaho-server-78855f6777-z62w6` with the actual pod name if it differs.
    - The `-n pentaho-server` flag specifies the namespace where the Pentaho Server is deployed.
    - The -f flag is used to follow the logs in real-time.
3. When you run the command "kubectl get svc -n pentaho-server", make sure you get type as NodePort.
    - If you find different type, you can change the type by editing with command "kubectl edit svc pentaho-server -n pentaho-server"
4. Run the command "kubectl get pods -o wide -n pentaho-server" to get the pod name and node name, and port.
5. Add firewall rules to allow traffic to the node port.
   - Use the command `gcloud compute firewall-rules create allow-pentaho-server --allow tcp:<node-port> --source-ranges
6. Run the command "kubectl get pods -o wide" to get the node name and external IP address.
   - Use the external IP address and port from points 3 and 4 to access the Pentaho User Console (PUC).
   - `http://IPAddress:port/pentaho`