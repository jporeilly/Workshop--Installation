--
-- These queries create OLTP logging tables for a Microsoft SQL Server database
--
-- 

USE master
IF EXISTS(select * from sys.databases where name = N'pentaho_dilogs')
DROP DATABASE pentaho_dilogs
GO
CREATE DATABASE pentaho_dilogs
GO
IF NOT EXISTS 
    (SELECT name  
     FROM master.sys.server_principals
     WHERE name = N'dilogs_user')
CREATE LOGIN dilogs_user WITH PASSWORD = N'password', CHECK_POLICY = OFF
GO

USE pentaho_dilogs;
CREATE USER dilogs_user FOR LOGIN dilogs_user
EXEC sp_addrolemember N'db_owner', N'dilogs_user'
GO

-- Job log table
--

CREATE TABLE job_logs
(
  ID_JOB INTEGER
, CHANNEL_ID VARCHAR(255)
, JOBNAME VARCHAR(255)
, STATUS VARCHAR(15)
, LINES_READ BIGINT
, LINES_WRITTEN BIGINT
, LINES_UPDATED BIGINT
, LINES_INPUT BIGINT
, LINES_OUTPUT BIGINT
, LINES_REJECTED BIGINT
, ERRORS BIGINT
, STARTDATE DATETIME2
, ENDDATE DATETIME2
, LOGDATE DATETIME2
, DEPDATE DATETIME2
, REPLAYDATE DATETIME2
, LOG_FIELD VARCHAR(MAX)
, EXECUTING_SERVER VARCHAR(255)
, EXECUTING_USER VARCHAR(255)
, START_JOB_ENTRY VARCHAR(255)
, CLIENT VARCHAR(255)
)
;
CREATE INDEX IDX_job_logs_1 ON job_logs(ID_JOB)
;
CREATE INDEX IDX_job_logs_2 ON job_logs(ERRORS, STATUS, JOBNAME)
;



-- Job entry log table
--

CREATE TABLE jobentry_logs
(
  ID_BATCH INTEGER
, CHANNEL_ID VARCHAR(255)
, LOG_DATE DATETIME2
, TRANSNAME VARCHAR(255)
, STEPNAME VARCHAR(255)
, LINES_READ BIGINT
, LINES_WRITTEN BIGINT
, LINES_UPDATED BIGINT
, LINES_INPUT BIGINT
, LINES_OUTPUT BIGINT
, LINES_REJECTED BIGINT
, ERRORS BIGINT
, RESULT CHAR(5)
, NR_RESULT_ROWS BIGINT
, NR_RESULT_FILES BIGINT
, LOG_FIELD VARCHAR(MAX)
, COPY_NR INTEGER
)
;
CREATE INDEX IDX_jobentry_logs_1 ON jobentry_logs(ID_BATCH)
;


-- Logging channel log table
--

CREATE TABLE channel_logs
(
  ID_BATCH INTEGER
, CHANNEL_ID VARCHAR(255)
, LOG_DATE DATETIME2
, LOGGING_OBJECT_TYPE VARCHAR(255)
, OBJECT_NAME VARCHAR(255)
, OBJECT_COPY VARCHAR(255)
, REPOSITORY_DIRECTORY VARCHAR(255)
, FILENAME VARCHAR(255)
, OBJECT_ID VARCHAR(255)
, OBJECT_REVISION VARCHAR(255)
, PARENT_CHANNEL_ID VARCHAR(255)
, ROOT_CHANNEL_ID VARCHAR(255)
)
;
CREATE TABLE checkpoint_logs
(
  ID_JOB_RUN INTEGER
, ID_JOB INTEGER
, JOBNAME VARCHAR(255)
, NAMESPACE VARCHAR(255)
, CHECKPOINT_NAME VARCHAR(255)
, CHECKPOINT_COPYNR SMALLINT
, ATTEMPT_NR INTEGER
, JOB_RUN_START_DATE DATETIME2
, LOGDATE DATETIME2
, RESULT_XML VARCHAR(MAX)
, PARAMETER_XML VARCHAR(MAX)
)
;
CREATE INDEX IDX_checkpoint_logs_1 ON checkpoint_logs(ID_JOB_RUN)
;
CREATE INDEX IDX_checkpoint_logs_2 ON checkpoint_logs(JOBNAME, NAMESPACE)
;


-- Transformation log table
--

CREATE TABLE trans_logs
(
  ID_BATCH INTEGER
, CHANNEL_ID VARCHAR(255)
, TRANSNAME VARCHAR(255)
, STATUS VARCHAR(15)
, LINES_READ BIGINT
, LINES_WRITTEN BIGINT
, LINES_UPDATED BIGINT
, LINES_INPUT BIGINT
, LINES_OUTPUT BIGINT
, LINES_REJECTED BIGINT
, ERRORS BIGINT
, STARTDATE DATETIME2
, ENDDATE DATETIME2
, LOGDATE DATETIME2
, DEPDATE DATETIME2
, REPLAYDATE DATETIME2
, LOG_FIELD VARCHAR(MAX)
, EXECUTING_SERVER VARCHAR(255)
, EXECUTING_USER VARCHAR(255)
, CLIENT VARCHAR(255)
)
;
CREATE INDEX IDX_trans_logs_1 ON trans_logs(ID_BATCH)
;
CREATE INDEX IDX_trans_logs_2 ON trans_logs(ERRORS, STATUS, TRANSNAME)
;

-- Step log table
--

CREATE TABLE step_logs
(
  ID_BATCH INTEGER
, CHANNEL_ID VARCHAR(255)
, LOG_DATE DATETIME2
, TRANSNAME VARCHAR(255)
, STEPNAME VARCHAR(255)
, STEP_COPY SMALLINT
, LINES_READ BIGINT
, LINES_WRITTEN BIGINT
, LINES_UPDATED BIGINT
, LINES_INPUT BIGINT
, LINES_OUTPUT BIGINT
, LINES_REJECTED BIGINT
, ERRORS BIGINT
, LOG_FIELD VARCHAR(MAX)
)
;


-- Step performance log table
--

CREATE TABLE transperf_logs
(
  ID_BATCH INTEGER
, SEQ_NR INTEGER
, LOGDATE DATETIME2
, TRANSNAME VARCHAR(255)
, STEPNAME VARCHAR(255)
, STEP_COPY INTEGER
, LINES_READ BIGINT
, LINES_WRITTEN BIGINT
, LINES_UPDATED BIGINT
, LINES_INPUT BIGINT
, LINES_OUTPUT BIGINT
, LINES_REJECTED BIGINT
, ERRORS BIGINT
, INPUT_BUFFER_ROWS BIGINT
, OUTPUT_BUFFER_ROWS BIGINT
)
;


-- Metrics log table
--

CREATE TABLE metrics_logs
(
  ID_BATCH INTEGER
, CHANNEL_ID VARCHAR(255)
, LOG_DATE DATETIME2
, METRICS_DATE DATETIME2
, METRICS_CODE VARCHAR(255)
, METRICS_DESCRIPTION VARCHAR(255)
, METRICS_SUBJECT VARCHAR(255)
, METRICS_TYPE VARCHAR(255)
, METRICS_VALUE BIGINT
)
;
