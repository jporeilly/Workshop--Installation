---
apiVersion: v1
kind: Namespace
metadata:
  name: pentaho-server
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gcs-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  csi:
    driver: gcsfuse.csi.storage.gke.io
    volumeHandle: "pentaho-eng-dev" # this must be globally unique
    volumeAttributes:
      bucketName: "pentaho-eng-dev"
      mountOptions: "implicit-dirs,uid=5000,gid=5000,file-mode=0770,dir-mode=0770"
  persistentVolumeReclaimPolicy: Retain

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gcs-pvc
  namespace: pentaho-server
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  volumeName: gcs-pv
  storageClassName: ""  # Empty string because we are using a pre-provisioned PV
---
# ServiceAccount for GCS access with correct IAM binding
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gcs-access-sa
  namespace: pentaho-server
  annotations:
    iam.gke.io/gcp-service-account: 890874994325-compute@developer.gserviceaccount.com
---
apiVersion: v1
kind: Secret
metadata:
  name: pentaho-license
  namespace: pentaho-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pentaho-server
  namespace: pentaho-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pentaho-server
  template:
    metadata:
      annotations:
        gke-gcsfuse/volumes: "true"
      labels:
        app: pentaho-server
        dinode: active
    spec:
      serviceAccountName: gcs-access-sa
      volumes:
        - name: persistent-storage
          persistentVolumeClaim:
            claimName: gcs-pvc
        - name: pentaho-license
          secret:
            secretName: pentaho-license
            optional: true
      containers:
      - name: pentaho-server
        image: us-east1-docker.pkg.dev/pentaho-lee-cheng/pentaho-docker-repo/pentaho-server:11.0.0.0-52
        imagePullPolicy: "Always"
        resources:
          limits:
            memory: "4Gi"
            cpu: 500m
            ephemeral-storage: 5Gi
          requests:
            memory: "2Gi"
            cpu: 250m
            ephemeral-storage: 2Gi
        ports:
          - containerPort: 8080
        volumeMounts:
          - name: persistent-storage
            mountPath: /docker-entrypoint-init/
            subPath: ackbar-dev/oracle/softwareOverride
            readOnly: false
          - name: persistent-storage
            mountPath: /opt/pentaho/solution/
            subPath: ackbar-dev/oracle/solutionFiles
            readOnly: false
          - name: persistent-storage
            mountPath: /home/pentaho
            subPath: ackbar-dev/oracle/config
            readOnly: false
          - name: persistent-storage
            mountPath: /opt/pentaho/pentaho-server/tomcat/logs
            subPath: ackbar-dev/oracle/logs
            readOnly: false
        env:
            - name: LICENSE_URL
              value: "https://flex1826-uat.compliance.flexnetoperations.com/instances/QP5BXJRC2XVM/request"
---
apiVersion: v1
kind: Service
metadata:
  name: pentaho-server-service
  namespace: pentaho-server
  labels:
    app: pentaho-server-service
spec:
  type: LoadBalancer
  selector:
    app: pentaho-server
    dinode: active
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: pentaho-server
  name: pentaho-server-ingress
  annotations:
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "http-cookie"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: pentaho-server-service
                port:
                  number: 8080
