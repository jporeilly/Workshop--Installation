---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: s3-storage-class
provisioner: s3.csi.aws.com
---
apiVersion: v1
kind: Namespace
metadata:
  name: pentaho-server
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pentaho-server-s3-access
  namespace: pentaho-server
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::524647911006:role/dockmaker-role-ps
---
# PV + PVC for softwareOverride
apiVersion: v1
kind: PersistentVolume
metadata:
  name: s3-pv-softwareoverride
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  claimRef: # To ensure no other PVCs can claim this PV
    namespace: pentaho-server # Namespace is required even though it's in "default" namespace.
    name: s3-pvc-softwareoverride # Name of your PVC
  volumeMode: Filesystem
  mountOptions:
    - allow-other
    - region us-east-1
    - prefix dockmaker/mysql/softwareOverride/
  csi:
    driver: s3.csi.aws.com
    volumeHandle: s3-softwareoverride
    volumeAttributes:
      bucketName: ackbar-development
      mountOptions: "uid=5000,gid=5000,file-mode=0770,dir-mode=0770"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: s3-pvc-softwareoverride
  namespace: pentaho-server
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  volumeMode: Filesystem
  resources:
    requests:
      storage: 1Gi
  volumeName: s3-pv-softwareoverride
---
# PV + PVC for config
apiVersion: v1
kind: PersistentVolume
metadata:
  name: s3-pv-config
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  claimRef: # To ensure no other PVCs can claim this PV
    namespace: pentaho-server # Namespace is required even though it's in "default" namespace.
    name: s3-pvc-config # Name of your PVC
  volumeMode: Filesystem
  mountOptions:
    - allow-other
    - region us-east-1
    - prefix dockmaker/mysql/config/
  csi:
    driver: s3.csi.aws.com
    volumeHandle: s3-config
    volumeAttributes:
      bucketName: ackbar-development
      mountOptions: "uid=5000,gid=5000,file-mode=0770,dir-mode=0770"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: s3-pvc-config
  namespace: pentaho-server
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  volumeMode: Filesystem
  resources:
    requests:
      storage: 1Gi
  volumeName: s3-pv-config
---
# PV + PVC for logs
apiVersion: v1
kind: PersistentVolume
metadata:
  name: s3-pv-logs
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  claimRef: # To ensure no other PVCs can claim this PV
    namespace: pentaho-server # Namespace is required even though it's in "default" namespace.
    name: s3-pvc-logs # Name of your PVC
  volumeMode: Filesystem
  mountOptions:
    - allow-other
    - region us-east-1
    - prefix dockmaker/mysql/logs/
  csi:
    driver: s3.csi.aws.com
    volumeHandle: s3-logs
    volumeAttributes:
      bucketName: ackbar-development
      mountOptions: "uid=5000,gid=5000,file-mode=0770,dir-mode=0770"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: s3-pvc-logs
  namespace: pentaho-server
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: s3-storage-class
  volumeMode: Filesystem
  resources:
    requests:
      storage: 1Gi
  volumeName: s3-pv-logs
---
apiVersion: v1
kind: Secret
metadata:
  name: pentaho-license
  namespace: pentaho-server
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pentaho-server
  namespace: pentaho-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pentaho-server
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        app: pentaho-server
        dinode: active
    spec:
      serviceAccountName: pentaho-server-s3-access
      securityContext:
        runAsUser: 5000
        runAsGroup: 5000
        runAsNonRoot: true
      volumes:
        - name: softwareoverride
          persistentVolumeClaim:
            claimName: s3-pvc-softwareoverride
        - name: config
          persistentVolumeClaim:
            claimName: s3-pvc-config
        - name: logs
          emptyDir: {}
        - name: pentaho-license
          secret:
            secretName: pentaho-license
            optional: true
      containers:
        - name: pentaho-server
          image: 524647911006.dkr.ecr.us-east-2.amazonaws.com/dockmaker/pentaho-server:11.0.0.0-18
          imagePullPolicy: "Always"
          resources:
            limits:
              memory: "4500Mi"
            requests:
              memory: "2000Mi"
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: softwareoverride
              mountPath: /docker-entrypoint-init/
            - name: config
              mountPath: /mnt/config
            - name: logs
              mountPath: /opt/pentaho/pentaho-server/tomcat/logs
          env:
            - name: LICENSE_URL
              value: "https://flex1826-uat.compliance.flexnetoperations.com/instances/QP5BXJRC2XVM/request"
        - name: s3-ps
          image: amazon/aws-cli:2.15.0
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
          args:
            - |
              while true; do
                echo "Uploading logs to S3"
                aws s3 sync /logs s3://ackbar-development/dockmaker/mysql/logs/ --region us-east-2
                sleep 60
              done
          env:
            - name: HOME
              value: /tmp
          volumeMounts:
            - name: logs
              mountPath: /logs
---
apiVersion: v1
kind: Service
metadata:
  name: pentaho-server-service
  namespace: pentaho-server
  labels:
    app: pentaho-server-service
spec:
  type: ClusterIP
  selector:
    app: pentaho-server
    dinode: active
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: database
      port: 3306
      targetPort: 3306
      protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: pentaho-server
  name: pentaho-server-ingress
  annotations:
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "http-cookie"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: pentaho-server-service
                port:
                  number: 8080
