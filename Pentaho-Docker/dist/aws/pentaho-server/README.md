# Pentaho Server Docker Project

This project provides a Docker setup for Pentaho Server (PUC). The setup includes Dockerfiles, Docker Compose configurations, and necessary scripts to build and run Pentaho Server in a containerized environment.

## Project Structure

### `dist/aws/pentaho-server/`

This folder contains resources and configurations for running Pentaho Server Docker container with several database variants. For this example we will use MySql database.

- **`pentaho-server-mysql/`**: Contains Docker Compose configurations for running Pentaho Server with MySql database.
    - **`pentaho-server-aws-mysql.yaml`**: Yaml file for deploying Pentaho Server with MySql database into kubernetes cluster.

### `config/`
This folder contains configuration files for the Pentaho Server. It is mounted as a volume in the Docker container to allow customization of the server settings.

### `db_init_mysql/`
This folder should contain the database scripts which needs to be run in the RDS DB Instance.

### `logs/`
This folder is used to store logs generated by the Pentaho Server. It is mounted as a volume in the Docker container to persist logs across container restarts.

### `softwareOverride/`
This folder should contain any configuration files that need to override the default configurations in the Pentaho Server installation.

## Usage

### Prerequisites

- Docker
- Docker Compose

### Building the Docker Image

1. Navigate to the `assemblies/pentaho-sever/` directory.
2. Place the required Pentaho Server distribution software ZIP files in the `assemblies/pentaho-server/stagedArtifacts/` folder.
3. Change the `Dockerfile` `ARG PENTAHO_VERSION` to the desired version of Pentaho Server.
4. Build the Docker image using the following command:
   ```sh
   docker build -t pentaho/pentaho-server:11.x .
   ```
5. tag this image and push it using following commands into ECR
    ```sh
    docker tag <image name> <ecr-uri>/<image-name-on-acr>
    docker push <login-server>/<image-name-on-ecr>
    ```
    ```sh
   following exmple is shown below
    docker tag pentaho/pentaho-server:10.3.0.0-272 524647911006.dkr.ecr.us-east-2.amazonaws.com/dockmaker-pentaho-server:272
    docker push 524647911006.dkr.ecr.us-east-2.amazonaws.com/dockmaker-pentaho-server:272
   ```
## Update yaml Files

Create EKS cluster, S3 Storage buckets and folders, File Share and Container Registry.

Update followings in the yaml files

1- PersistentVolume:mountOptions:prefix # Replace with your aws bucket path for each mount path
   - csi:volumeAttributes:bucketName # Replace with your AWS bucket name

2- containers:image Replace with your image

3- env:LICENSE_URL # Replace with your actual license URL

Other values can be changed or keep the name same as YAML file like Namespace, PersistentVolume, PersistentVolumeClaim, ServiceAccount etc..


### Deploying into Kubernates and checking logs

1. `kubectl apply -f /<path>/pentaho-server-aws-mysql.yaml`
    - This command will deploy the Pentaho Server with MySQL database into the Kubernetes cluster.
    - Ensure that the Kubernetes cluster is configured and running.
    - This creates the service account along with the persistent volume and persistent volume claim.
      The trust identity needs to be updated. IAM role and IRSA needs to be updated with the correct SA or additional SA using bellow example.
      The service account "pentaho-server-s3-access" is specific to Pentaho Server in pentaho-server namespace.
```sh
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::524647911006:oidc-provider/oidc.eks.us-east-2.amazonaws.com/id/61F286D24DBBC7A6639A2405B1CC873D"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "oidc.eks.us-east-2.amazonaws.com/id/61F286D24DBBC7A6639A2405B1CC873D:sub": "system:serviceaccount:pentaho-server:pentaho-server-s3-access"
                }
            }
        }
    ]
}
```
2. `kubectl logs -f pentaho-server-78855f6777-z62w6  -n pentaho-server --all-containers`
    - This command will show the logs of the Pentaho Server pod.
    - Replace `pentaho-server-78855f6777-z62w6` with the actual pod name if it differs.
    - The `-n pentaho-server` flag specifies the namespace where the Pentaho Server is deployed.
    - The -f flag is used to follow the logs in real-time.
3. After the server has started, use the following command to get the external IP to access PUC.
   `kubectl port-forward pentaho-server-78855f6777-z62w6 8080:8080 -n pentaho-server`
4. PUC page can be access via:
   `http://localhost:8080/pentaho`
