# Service for Carte
apiVersion: v1
kind: Service
metadata:
  name: carte-service
  namespace: pdi
  labels:
    app: carte-service
spec:
  type: NodePort
  selector:
    app: carte
  ports:
    - port: 8081
      targetPort: 8081
      nodePort: 30081
---
# Deployment with direct mounts (no subPath)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: carte
  namespace: pdi
  labels:
    app: carte
spec:
  replicas: 1
  selector:
    matchLabels:
      app: carte
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        app: carte
    spec:
      serviceAccountName: pdi-s3-access
      securityContext:
        runAsUser: 5000
        runAsGroup: 5000
        runAsNonRoot: true
      volumes:
        - name: softwareoverride
          persistentVolumeClaim:
            claimName: s3-pvc-softwareoverride
        - name: solutionfiles
          persistentVolumeClaim:
            claimName: s3-pvc-solutionfiles
        - name: config
          persistentVolumeClaim:
            claimName: s3-pvc-config
        - name: logs
          emptyDir: {}
      containers:
        - name: carte
          image: 524647911006.dkr.ecr.us-east-2.amazonaws.com/dockmaker-pdi:11.0.0.0-18
          imagePullPolicy: Always
          resources:
            limits:
              memory: "2500Mi"
            requests:
              memory: "1500Mi"
          ports:
            - containerPort: 8081
          volumeMounts:
            - name: softwareoverride
              mountPath: /docker-entrypoint-init/
            - name: solutionfiles
              mountPath: /mnt/solutionfiles
            - name: config
              mountPath: /mnt/config
            - name: logs
              mountPath: /opt/pentaho/data-integration/logs
          args: ["/opt/pentaho/data-integration/carte.sh", "/mnt/config/carte-config.xml"]
          env:
            - name: LICENSE_URL
              value: "https://flex1826-uat.compliance.flexnetoperations.com/instances/QP5BXJRC2XVM/request"
        - name: s3-test
          image: amazon/aws-cli:2.15.0
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
          args:
            - |
              while true; do
                echo "Uploading logs to S3"
                aws s3 sync /logs s3://ackbar-development/dockmaker/pdi/logs/ --region us-east-2
                sleep 60
              done
          env:
            - name: HOME
              value: /tmp
          volumeMounts:
            - name: logs
              mountPath: /logs
