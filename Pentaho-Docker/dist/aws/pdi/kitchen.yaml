
apiVersion: batch/v1
kind: Job
metadata:
  name: kitchen-job  # Choose a unique job name
  namespace: pdi  # Must match the namespace above
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: kitchen
    spec:
      restartPolicy: Never
      serviceAccountName: pdi-s3-access
      securityContext:
        runAsUser: 5000
        runAsGroup: 5000
        runAsNonRoot: true
      volumes:
        - name: softwareoverride
          persistentVolumeClaim:
            claimName: s3-pvc-softwareoverride
        - name: solutionfiles
          persistentVolumeClaim:
            claimName: s3-pvc-solutionfiles
        - name: config
          persistentVolumeClaim:
            claimName: s3-pvc-config
        - name: logs
          emptyDir: {}
      containers:
        - name: kitchen
          image: 524647911006.dkr.ecr.us-east-2.amazonaws.com/dockmaker-pdi:11.0.0.0-18
          imagePullPolicy: "Always"
          resources:
            limits:
              memory: "512Mi"
            requests:
              memory: "512Mi"
          ports:
            - containerPort: 8081
          volumeMounts:
            - name: softwareoverride
              mountPath: /docker-entrypoint-init/
            - name: solutionfiles
              mountPath: /mnt/solutionfiles
            - name: config
              mountPath: /mnt/config
            - name: logs
              mountPath: /opt/pentaho/data-integration/logs
          args: [ "/opt/pentaho/data-integration/kitchen.sh", "-file=/opt/pentaho/data-integration/samples/jobs/arguments/Set arguments on a transformation.kjb" ]
          env:
            - name: LICENSE_URL
              value: "https://flex1826-uat.compliance.flexnetoperations.com/instances/QP5BXJRC2XVM/request"
        - name: s3-test
          image: amazon/aws-cli:2.15.0
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
          args:
            - |
              while true; do
                echo "Uploading logs to S3"
                aws s3 sync /logs s3://ackbar-development/dockmaker/pdi/logs/ --region us-east-2
                sleep 60
              done
          env:
            - name: HOME
              value: /tmp
          volumeMounts:
            - name: logs
              mountPath: /logs