# Namespace for grouping resources
apiVersion: v1
kind: Namespace
metadata:
  name: pentaho-server  # Replace (optional) with your desired namespace name
---
apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: file.csi.azure.com
  name: pdia-pv # Must match the name in PersistentVolumeClaim
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: azurefile-csi
  csi:
    driver: file.csi.azure.com
    volumeHandle: "{pdia-docker-ackbar}#{pdiadockerstorage}#{pdia-docker-file-share-postgres}"  # replace with your unique volume ID e.g. {resource-group-name}#{storage-account-name}#{file-share-name}
    volumeAttributes:
      shareName: pdia-docker-file-share-postgres # replace with your file share name
    nodeStageSecretRef:
      name: pdia-fileshareaccount-secret # Match the name used in Secret for Azure Storage Account
      namespace: pentaho-server # Must match the namespace
  mountOptions:
    - dir_mode=0777
    - file_mode=0777
    - uid=0
    - gid=0
    - mfsymlinks
    - cache=strict
    - nosharesock
    - nobrl  # disable sending byte range lock requests to the server and for applications which have challenges with posix locks
---
# Secret for Azure Storage Account credentials
apiVersion: v1
kind: Secret
metadata:
  name: pdia-fileshareaccount-secret  # Match the name used in PV
  namespace: pentaho-server  # Must match the namespace
type: Opaque
stringData:
  azurestorageaccountname: pdiadockerstorage  # Replace with your Azure Storage Account name
  azurestorageaccountkey: SJp+vN/MhoP5xfCXtg9y7ujTIfUBrO/jXBt7TzTZryZ8BDFZbKpY3XskvbVEbuqdwaAhWv8XmLI4+AStSFB0AA==  # Replace with your Storage Account key

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pdia-pv # Must match the name in PersistentVolumeClaim
  namespace: pentaho-server # Must match the namespace
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: azurefile-csi
  volumeName: pdia-pv # Must match the name in PersistentVolume
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pentaho-server
  namespace: pentaho-server # Must match the namespace
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pentaho-server
  template:
    metadata:
      labels:
        app: pentaho-server
        dinode: active
    spec:
      containers:
        - name: pentaho-server
          image: pentahopdia.azurecr.io/pentaho-server:11.0.0.0-xxx # Replace with your image
          imagePullPolicy: "Always"
          resources:
            limits:
              memory: "4500Mi"
            requests:
              memory: "2000Mi"
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: azure-file-share
              mountPath: /docker-entrypoint-init/
              subPath: softwareOverride
              readOnly: false
            - name: azure-file-share
              mountPath: /opt/pentaho/pentaho-server/tomcat/logs
              subPath: logs
              readOnly: false
            - name: azure-file-share
              mountPath: /home/pentaho
              subPath: config
              readOnly: false
          env:
            - name: LICENSE_URL
              value: "https://flex1826-uat.compliance.flexnetoperations.com/instances/QP5BXJRC2XVM/request"# Replace with your license URL
      volumes:
        - name: azure-file-share
          persistentVolumeClaim:
            claimName: pdia-pv # Must match the name in PersistentVolumeClaim
---
# LoadBalancer service to expose the application
apiVersion: v1
kind: Service
metadata:
  name: pentaho-loadbalancer-service  # Replace (optional) with your service name
  namespace: pentaho-server  # Must match the namespace
  labels:
    app: pentaho-server
spec:
  type: LoadBalancer
  selector:
    app: pentaho-server  # Must match the label in the deployment
  ports:
    - port: 8080
      targetPort: 8080

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: pentaho-server # Must match the namespace
  name: pentaho-server-ingress
  annotations:
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "http-cookie"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: pentaho-server-service
                port:
                  number: 8080
