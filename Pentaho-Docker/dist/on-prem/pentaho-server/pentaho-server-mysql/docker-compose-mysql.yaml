services:
  pentaho-server:
    image: ${PENTAHO_IMAGE_NAME}:${PENTAHO_VERSION}
    platform: linux/amd64    
    build:    
      args:
        PENTAHO_VERSION: ${PENTAHO_VERSION}
    hostname: pentaho-server-mysql
    ports:
      - "${PORT}:8080"
    stop_grace_period: "0s"
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 5g
    volumes:
      #SOFTWARE_OVERRIDE_FOLDER is a folder that contains the software "changes" that will be copied to the container
      - "${SOFTWARE_OVERRIDE_FOLDER}/:/docker-entrypoint-init"

      #CONFIG_FOLDER is a folder that contains the configuration files that will be copied to the container
      - "${CONFIG_FOLDER}:${PENTAHO_HOME}"

      #LOG_FOLDER is a folder that contains the log files that will be generated by the container
      - "${LOG_FOLDER}:/opt/pentaho/pentaho-server/tomcat/logs"

      #AdditionalVolumePlaceholder-Do not modify this line.
    environment:
      #Following XMS, XMX can be changed and these values will be taken when starting server.
      JAVA_XMS: "2048m"
      JAVA_XMX: "6144m"
      JAVA_OPTS_EXTRA: >-
        -XX:MinRAMPercentage=50.0
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
      LICENSE_URL: ${LICENSE_URL}
      KETTLE_HOME: ${PENTAHO_HOME}
      PENTAHO_HOME: /home/pentaho/
      PENTAHO_VERSION: ${PENTAHO_VERSION}


    depends_on:
      repository:
        condition: service_healthy

  repository:
    image: ${DOCKER_DATABASE_IMAGE}
    hostname: repository
    ports:
      - "3306:3306"
    entrypoint: ["/entrypoint.sh", "--log-error=/var/log/mysqld.log", "--bind-address=0.0.0.0"]
    environment:
      - MYSQL_ROOT_PASSWORD=password
    volumes:
      - "./db_init_mysql/:/docker-entrypoint-initdb.d/"
      - repository-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-ppassword"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  repository-data:
  server_jackrabbit:
